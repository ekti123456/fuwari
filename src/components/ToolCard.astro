---
import { umamiConfig, statsConfig } from "@/config";

interface Props {
  tool: {
    name: string;
    description: string;
    icon: string;
    slug?: string;
    statsPath?: string;
  };
}

const { tool } = Astro.props;
const id = `tool-stats-${tool.slug || encodeURIComponent(tool.name)}`;
const statsPath = tool.statsPath || (tool.slug ? `/tools/${tool.slug}/` : null);
---

<a href={tool.slug ? `/tools/${tool.slug}/` : `#`} class:list={["tool-card", {"pointer-events-none": !tool.slug}] }>
  <img src={tool.icon} loading="lazy" class="tool-icon" alt={`${tool.name}图标`}>
  <div class="flex-1 min-w-0">
    <div class="font-bold text-black dark:text-white">{tool.name}</div>
    <div class="text-sm text-black/50 dark:text-white/50 line-clamp-2">{tool.description}</div>
    {statsPath && (
      <div class="text-sm text-black/30 dark:text-white/30 mt-1">
        <span id={id}>{statsConfig.loadingText}</span>
      </div>
    )}
  </div>
</a>

{statsPath && (
<script define:vars={{ id, statsPath, umamiConfig, unavailableText: statsConfig.unavailableText, viewsText: statsConfig.viewsText, visitsText: statsConfig.visitsText }}>
    function generateStatsText(pageViews, visits) {
      return `${viewsText} ${pageViews} · ${visitsText} ${visits}`;
    }

    async function fetchWithTimeout(promise, ms) {
      return await Promise.race([
        promise,
        new Promise((_, reject) => setTimeout(() => reject(new Error('timeout')), ms)),
      ]);
    }

    async function fetchToolStats(path, id, isRetry = false) {
      if (!umamiConfig.enable) return;
      try {
        // Wait for getUmamiShareData to be available
        if (typeof getUmamiShareData !== 'function') {
            setTimeout(() => fetchToolStats(path, id, isRetry), 100);
            return;
        }

        const { websiteId, token } = await getUmamiShareData(umamiConfig.baseUrl, umamiConfig.shareId);
        const currentTimestamp = Date.now();
        const encoded = encodeURIComponent(path);
        const hostnameParam = umamiConfig.hostname ? `&hostname=eq.${encodeURIComponent(umamiConfig.hostname)}` : '';
        const statsUrl = `${umamiConfig.baseUrl}/analytics/us/api/websites/${websiteId}/stats?startAt=0&endAt=${currentTimestamp}&unit=hour&timezone=${encodeURIComponent(umamiConfig.timezone)}&path=eq.${encoded}${hostnameParam}&compare=false`;

        const statsResponse = await fetchWithTimeout(fetch(statsUrl, { headers: { 'x-umami-share-token': token } }), 5000);
        if (!statsResponse.ok) {
          if (statsResponse.status === 401 && !isRetry) {
            clearUmamiShareCache();
            return fetchToolStats(path, id, true);
          }
          throw new Error('failed');
        }
        const statsData = await statsResponse.json();
        const pageViews = statsData.pageviews || 0;
        const visits = statsData.visitors || 0;
        const displayElement = document.getElementById(id);
        if (displayElement) displayElement.textContent = generateStatsText(pageViews, visits);
      } catch (error) {
        console.error('Error fetching stats for', path, error);
        const displayElement = document.getElementById(id);
        if (displayElement) displayElement.textContent = unavailableText;
      }
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => fetchToolStats(statsPath, id));
    } else {
      fetchToolStats(statsPath, id);
    }
</script>
)}

<style>
  .tool-card {
    @apply flex flex-row items-center gap-3 p-4 rounded-lg bg-[var(--card-bg)] hover:bg-black/5 dark:hover:bg-white/5;
    transition-property: all;
    transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
    transition-duration: 0.15s;
  }
  .tool-card:active { scale: .98; background-color: var(--btn-regular-bg-active); }
  .tool-card:hover { background-color: var(--btn-regular-bg-hover); }
  .tool-card:hover .font-bold { color: var(--btn-content); }
  .tool-card:hover .text-sm { @apply text-gray-700 dark:text-white; }
  .tool-card .font-bold, .tool-card .text-sm {
    transition-property: color;
    transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
    transition-duration: 0.15s;
  }
  .tool-icon { @apply w-16 h-16 rounded-lg object-cover; }
</style>
