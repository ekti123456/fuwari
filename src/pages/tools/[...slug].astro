---
import path from "node:path";
import License from "@components/misc/License.astro";
import Markdown from "@components/misc/Markdown.astro";
import MainGridLayout from "@layouts/MainGridLayout.astro";
import { Icon } from "astro-icon/components";
import PostMetadata from "../../components/PostMeta.astro";
import ImageWrapper from "../../components/misc/ImageWrapper.astro";
import { profileConfig, siteConfig, umamiConfig, statsConfig } from "../../config";
import { formatDateToYYYYMMDD } from "../../utils/date-utils";
import { getCollection } from "astro:content";
import toolsData from "../../data/tools.json";

export async function getStaticPaths() {
  const entries = await getCollection("tools", ({ data }) => {
    return import.meta.env.PROD ? data.draft !== true : true;
  });
  const sorted = entries.sort((a, b) => {
    const dateA = new Date(a.data.published);
    const dateB = new Date(b.data.published);
    return dateA > dateB ? -1 : 1;
  });
  for (let i = 1; i < sorted.length; i++) {
    sorted[i].data.nextSlug = sorted[i - 1].slug;
    sorted[i].data.nextTitle = sorted[i - 1].data.title;
  }
  for (let i = 0; i < sorted.length - 1; i++) {
    sorted[i].data.prevSlug = sorted[i + 1].slug;
    sorted[i].data.prevTitle = sorted[i + 1].data.title;
  }
  return sorted.map((entry) => ({ params: { slug: entry.slug }, props: { entry } }));
}

const { entry } = Astro.props;
const { Content, headings } = await entry.render();
const { remarkPluginFrontmatter } = await entry.render();

const jsonLd = {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  headline: entry.data.title,
  description: entry.data.description || entry.data.title,
  keywords: entry.data.tags,
  author: { "@type": "Person", name: profileConfig.name, url: Astro.site },
  datePublished: formatDateToYYYYMMDD(entry.data.published),
  inLanguage: entry.data.lang ? entry.data.lang.replace("_", "-") : siteConfig.lang.replace("_", "-"),
};

let externalUrl: string | null = null;
try {
  const data = toolsData as any;
  const match = (data?.tools || []).find((t: any) => t.slug === entry.slug);
  if (match && typeof match.url === 'string' && match.url) {
    externalUrl = match.url;
  }
} catch {}
---
<MainGridLayout banner={entry.data.image} title={entry.data.title} description={entry.data.description} lang={entry.data.lang} setOGTypeArticle={true} headings={headings}>
  <script is:inline slot="head" type="application/ld+json" set:html={JSON.stringify(jsonLd)}></script>
  <div class="flex w-full rounded-[var(--radius-large)] overflow-hidden relative mb-4">
    <div id="post-container" class:list={["card-base z-10 px-6 md:px-9 pt-6 pb-4 relative w-full ", {}]}>
      <div class="flex flex-row text-black/30 dark:text-white/30 gap-5 mb-3 transition onload-animation">
        <div class="flex flex-row items-center">
          <div class="transition h-6 w-6 rounded-md bg-black/5 dark:bg-white/10 text-black/50 dark:text-white/50 flex items-center justify-center mr-2">
            <Icon name="material-symbols:notes-rounded"></Icon>
          </div>
          <div class="text-sm">{remarkPluginFrontmatter.words} 字</div>
        </div>
        <div class="flex flex-row items-center">
          <div class="transition h-6 w-6 rounded-md bg-black/5 dark:bg-white/10 text-black/50 dark:text-white/50 flex items-center justify-center mr-2">
            <Icon name="material-symbols:schedule-outline-rounded"></Icon>
          </div>
          <div class="text-sm">{remarkPluginFrontmatter.minutes} 分钟</div>
        </div>
      </div>

      <div class="relative onload-animation">
        <div data-pagefind-body data-pagefind-weight="10" data-pagefind-meta="title" class="transition w-full flex items-center font-bold mb-3 text-3xl md:text-[2.25rem]/[2.75rem] text-black/90 dark:text-white/90 md:before:w-1 before:h-5 before:rounded-md before:bg-[var(--primary)] before:absolute before:top-[0.75rem] before:left-[-1.125rem]">
          <span>{entry.data.title}</span>
          {externalUrl && (
            <a href={externalUrl} target="_blank" rel="noopener noreferrer" class="ml-3 inline-flex items-center gap-1 px-3 py-1.5 rounded bg-[var(--btn-regular-bg)] hover:bg-[var(--btn-regular-bg-hover)] active:bg-[var(--btn-regular-bg-active)] text-[var(--btn-content)] text-xs font-bold transition-all active:scale-95">
              <Icon name="fa6-solid:arrow-up-right-from-square" class="text-[0.875rem]"></Icon>
              前往官网
            </a>
          )}
        </div>
      </div>

      {(entry.data.description || remarkPluginFrontmatter.excerpt) && (
        <div class="onload-animation mb-4">
          <div class="text-black/75 dark:text-white/75 text-sm leading-relaxed">{entry.data.description || remarkPluginFrontmatter.excerpt}</div>
        </div>
      )}

      <div class="onload-animation">
        <PostMetadata class="mb-5" published={entry.data.published} updated={entry.data.updated} tags={entry.data.tags} slug={entry.slug} basePath="/tools"></PostMetadata>
        {!entry.data.image && <div class="border-[var(--line-divider)] border-dashed border-b-[1px] mb-5"></div>}
      </div>

      {entry.data.image && <ImageWrapper id="post-cover" src={entry.data.image} basePath={path.join("content/tools/", entry.slug)} class="mb-8 rounded-xl banner-container onload-animation"/>}

      <Markdown class="mb-6 markdown-content onload-animation">
        <Content />
      </Markdown>

      <!-- 文章反馈与编辑区域 -->
      <div class="mb-4 p-4 rounded-lg bg-[var(--license-block-bg)] border border-[var(--line-divider)] onload-animation">
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center gap-3">
            <div class="h-5 w-5 rounded bg-[var(--primary)] flex items-center justify-center">
              <Icon name="material-symbols:help-outline" class="text-[0.75rem] text-white dark:text-black/70"></Icon>
            </div>
            <p class="text-black/80 dark:text-white/80 text-sm">这篇文章是否对你有帮助？</p>
          </div>
          <div class="flex gap-2">
            <a href="/posts/pin/" class="group flex items-center gap-1 px-3 py-1.5 rounded bg-[var(--btn-regular-bg)] hover:bg-[var(--btn-regular-bg-hover)] active:bg-[var(--btn-regular-bg-active)] text-[var(--btn-content)] text-xs font-medium transition-all active:scale-95">
              <Icon name="material-symbols:contact-mail-outline" class="text-[0.875rem] group-hover:scale-110 transition-transform"></Icon>
              联系
            </a>
            <a href="/donate/" class="group flex items-center gap-1 px-3 py-1.5 rounded bg-[var(--primary)] hover:bg-[oklch(0.65_0.16_var(--hue))] active:bg-[oklch(0.60_0.18_var(--hue))] text-white dark:text-black/80 text-xs font-medium transition-all active:scale-95">
              <Icon name="material-symbols:favorite-outline" class="text-[0.875rem] group-hover:scale-110 transition-transform"></Icon>
              赞助
            </a>
          </div>
        </div>

        <div class="border-t border-[var(--line-divider)] my-3"></div>
        <div class="flex items-start gap-3">
          <div class="h-5 w-5 rounded bg-[var(--primary)] flex items-center justify-center">
            <Icon name="material-symbols:edit-outline" class="text-[0.875rem] text-white dark:text-black/70"></Icon>
          </div>
          <div class="flex-1">
            <p class="text-black/80 dark:text-white/80 text-sm mb-1">发现错误或想要改进这篇文章？</p>
            <a href={`https://github.com/ekti123456/fuwari/blob/main/src/content/tools/${entry.slug}.md`} target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-1 text-[var(--primary)] hover:text-[oklch(0.65_0.16_var(--hue))] text-sm font-medium transition-colors">
              <Icon name="fa6-brands:github" class="text-[0.875rem]"></Icon>
              在 GitHub 上编辑此页
              <Icon name="material-symbols:open-in-new" class="text-[0.75rem]"></Icon>
            </a>
          </div>
        </div>
      </div>

      <License title={entry.data.title} slug={entry.slug} pubDate={entry.data.published} class="mb-6 rounded-xl license-container onload-animation"></License>

      <div class="flex flex-col md:flex-row justify-between mb-4 gap-4 overflow-hidden w-full onload-animation">
        <a href={entry.data.nextSlug ? `/tools/${entry.data.nextSlug}/` : "#"}
           class:list={["w-full font-bold overflow-hidden active:scale-95", {"pointer-events-none": !entry.data.nextSlug}]}>
            {entry.data.nextSlug && <div class="btn-card rounded-2xl w-full h-[3.75rem] max-w-full px-4 flex items-center !justify-start gap-4" >
                <Icon name="material-symbols:chevron-left-rounded" class="text-[2rem] text-[var(--primary)]" />
                <div class="overflow-hidden transition overflow-ellipsis whitespace-nowrap max-w-[calc(100%_-_3rem)] text-black/75 dark:text-white/75">
                    {entry.data.nextTitle}
                </div>
            </div>}
        </a>

        <a href={entry.data.prevSlug ? `/tools/${entry.data.prevSlug}/` : "#"}
           class:list={["w-full font-bold overflow-hidden active:scale-95", {"pointer-events-none": !entry.data.prevSlug}]}>
            {entry.data.prevSlug && <div class="btn-card rounded-2xl w-full h-[3.75rem] max-w-full px-4 flex items-center !justify-end gap-4">
                <div class="overflow-hidden transition overflow-ellipsis whitespace-nowrap max-w-[calc(100%_-_3rem)] text-black/75 dark:text-white/75">
                    {entry.data.prevTitle}
                </div>
                <Icon name="material-symbols:chevron-right-rounded" class="text-[2rem] text-[var(--primary)]" />
            </div>}
        </a>
      </div>

      <!-- Giscus 评论区 -->
      <script src="https://giscus.app/client.js"
              data-repo="ekti123456/fuwari"
              data-repo-id="R_kgDOQWqP5g"
              data-category="Announcements"
              data-category-id="DIC_kwDOQWqP5s4Cx2Sl"
              data-mapping="pathname"
              data-strict="0"
              data-reactions-enabled="1"
              data-emit-metadata="0"
              data-input-position="top"
              data-theme="noborder_gray"
              data-lang="zh-CN"
              data-loading="lazy"
              crossorigin="anonymous"
              async>
      </script>
      <br />
    </div>
  </div>
<script define:vars={{ entry, umamiConfig, unavailableText: statsConfig.unavailableText, viewsText: statsConfig.viewsText, visitsText: statsConfig.visitsText }}>
    // 客户端统计文案生成函数
    function generateStatsText(pageViews, visits) {
        return `${viewsText} ${pageViews} · ${visitsText} ${visits}`;
    }

    // 获取文章浏览量统计
    async function fetchToolViews(slug) {
        if (!umamiConfig.enable) {
            return;
        }

        try {
            // 注意：这里假设 getUmamiShareData 是全局可用的，或者是你之前定义过的工具函数
            // 如果报错 getUmamiShareData is not defined，你需要引入它或者把那个函数的代码粘贴到这里
            const { websiteId, token } = await getUmamiShareData(umamiConfig.baseUrl, umamiConfig.shareId);

            const currentTimestamp = Date.now();

            // !!! 关键修改点 !!!
            // 1. 将 path 改为 /tools/
            // 2. 加上 hostname 过滤
            const statsUrl = `${umamiConfig.baseUrl}/analytics/us/api/websites/${websiteId}/stats?startAt=0&endAt=${currentTimestamp}&unit=hour&timezone=${encodeURIComponent(umamiConfig.timezone)}&path=eq.%2Ftools%2F${slug}%2F&hostname=eq.${umamiConfig.hostname}&compare=false`;

            const statsResponse = await fetch(statsUrl, {
                headers: {
                    'x-umami-share-token': token
                }
            });

            if (statsResponse.status === 401) {
                // 简单的重试逻辑，或者清除缓存重新获取 token
                return;
            }

            if (!statsResponse.ok) {
                throw new Error('获取统计数据失败');
            }

            const statsData = await statsResponse.json();
            const pageViews = statsData.pageviews || 0;
            const visits = statsData.visitors || 0;

            // 更新 UI，ID 通常由 PostMetadata 组件生成，一般是 page-views-{slug}
            const displayElement = document.getElementById(`page-views-${slug}`);
             if (displayElement) {
                 displayElement.textContent = generateStatsText(pageViews, visits);
             }
        } catch (error) {
            console.error('Error fetching views for tool', slug, ':', error);
            const displayElement = document.getElementById(`page-views-${slug}`);
            if (displayElement) {
                displayElement.textContent = unavailableText;
            }
        }
    }

    // 页面加载完成后获取统计数据
    function initToolStats() {
        const slug = entry.slug;
        if (slug) {
            fetchToolViews(slug);
        }
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initToolStats);
    } else {
        initToolStats();
    }
</script>
</MainGridLayout>